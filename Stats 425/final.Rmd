---
title: "425 Final Project"
author: "Jacob Brown"
date: "2025-04-02"
output: 
  html_document:
    code_folding: hide
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(mosaic)
library(car)

dat <- read.csv("Clean_Dataset.csv", stringsAsFactors = TRUE)
```

### Are You Paying Too Much for Airline Tickets? {.tabset}

As someone who wants to travel around the world but doesn’t have a lot of money since I am still in college, I want to see the world on a budget. So, I am going to explore how to predict ticket prices based on a few variables. When buying a ticket, there are always multiple variables that impact the ticket price, such as the class you are flying in, the location, or the duration of the flight. My hope is that I can be accurate enough to save my money and see this amazing world.

##### Chepest Flight: Economy, with Two or More Layovers


#### Model

$$
\underbrace{y_i}_{\text{Ticket Price}} = \overbrace{\beta_0}^\text{Intercept} + 
\beta_1*\overbrace{x_i}^\text{duration} + 
\beta_2*\overbrace{x_i^2}^\text{duration} + 
\beta_3*\overbrace{x_i}^\text{Class} + 
\beta_4*\overbrace{x_i}^\text{Stops} + 
\beta_5*\overbrace{x_i^2}^\text{days_left} + 
\beta_6*\overbrace{x_i}^\text{Class} * \overbrace{x_i}^\text{duration} + 
\beta_7*\overbrace{x_i}^\text{Class} * \overbrace{x_i^2}^\text{duration} +
\beta_8*\overbrace{x_i}^\text{Class} * \overbrace{x_i^3}^\text{duration} +
\beta_9*\overbrace{x_i}^\text{Class} * \overbrace{x_i}^\text{days_left} +
\beta_10*\overbrace{x_i}^\text{duration} * \overbrace{x_i}^\text{stops} +
\beta_11*\overbrace{x_i}^\text{days_left} * \overbrace{x_i}^\text{stops}
$$

##### Spliting Data in Test and Train

```{r message=FALSE, warning=FALSE}
set.seed(117)

num_rows <- round((nrow(dat) * .8),0)
keep <- sample(1:nrow(dat), num_rows)

mytrain <- dat[keep, ] #Use this in the lm(..., data=mytrain) it is like "rbdata"

mytest <- dat[-keep, ] #Use this in the predict(..., newdata=mytest) it is like "rbdata2"
```

I have decided to split my data into a training and testing data set, using 80% for training and 20% for testing. This will later be used for model validation by testing how the model performs without seeing the answer key and then checking its predictions. I can then calculate the percentage of correct predictions to assess the accuracy of the model.

```{r message=FALSE, warning=FALSE}
air_train <- lm(price ~ duration + I(duration^2) + class + stops + I(days_left^2) + 
               class:(duration + I(duration^2) + I(duration^3) + days_left)+
               duration:stops+
               days_left:stops
             , data = mytrain)

summary(air_train)
```

This is where I will check to see what the validation accuracy is based on the testing data.

```{r message=FALSE, warning=FALSE}
# Predictions on test set
yh_test <- predict(air_train, newdata = mytest)

# Compute R-squared and Adjusted R-squared
ybar <- mean(mytest$price)
SSTO <- sum((mytest$price - ybar)^2)

SSE_test <- sum((mytest$price - yh_test)^2)

rs_test <- 1 - SSE_test / SSTO

n_test <- nrow(mytest)

p_train <- length(coef(air_train))

rsa_test <- 1 - ((n_test - 1) / (n_test - p_train)) * (SSE_test / SSTO)

# Output table
my_output_table2 <- data.frame(
  Model = "Test Validation",
  `Original R2` = summary(air_train)$r.squared,
  `Orig. Adj. R-squared` =  summary(air_train)$adj.r.squared,
  `Validation R-squared` = rs_test,
  `Validation Adj. R-squared` = rsa_test
)

# Fix column names for display
colnames(my_output_table2) <- c("Model", "Original R-squared", "Original Adj. R-squared", "Validation R-squared", "Validation Adj. R-squared")

# Render table
knitr::kable(my_output_table2, escape = FALSE, digits = 4)
```

We can see that the original adjusted $R^2$ is the same as the validation, so we know that the model is accurate with data it has not seen, making it truly accurate, and it’s not overfitting. The validation does not need to be exactly the same, but we want it close, within a percentage or two.

#### Graphs

##### Economy Class Non-Stop

```{r message=FALSE, warning=FALSE}
b <- coef(air_train)
drawit <- function(mean_vals) {
  curve(
    b["(Intercept)"] + 
    b["duration"] * x + 
    b["I(duration^2)"] * x^2 + 
    b["classEconomy"] * mean_vals$classEconomy + 
    b["stopstwo_or_more"] * mean_vals$stopstwo_or_more + 
    b["stopszero"] * mean_vals$stopszero + 
    b["I(days_left^2)"] * mean_vals$days_left^2 + 
    b["duration:classEconomy"] * x * mean_vals$classEconomy + 
    b["I(duration^2):classEconomy"] * x^2 * mean_vals$classEconomy + 
    b["classBusiness:I(duration^3)"] * mean_vals$classBusiness * x^3 + 
    b["classBusiness:days_left"] * mean_vals$classBusiness * mean_vals$days_left + 
    b["classEconomy:I(duration^3)"] * mean_vals$classEconomy * x^3 + 
    b["classEconomy:days_left"] * mean_vals$classEconomy * mean_vals$days_left + 
    b["duration:stopstwo_or_more"] * x * mean_vals$stopstwo_or_more + 
    b["duration:stopszero"] * x * mean_vals$stopszero + 
    b["stopstwo_or_more:days_left"] * mean_vals$stopstwo_or_more * mean_vals$days_left + 
    b["stopszero:days_left"] * mean_vals$stopszero * mean_vals$days_left, 

    from = min(mytrain$duration, na.rm = TRUE), 
    to = max(mytrain$duration, na.rm = TRUE), 
    add = TRUE, col = "blue", lwd = 2, ylab = "Prediction", xlab = "Duration"
  )
}

# Define the mean values correctly
mean_vals <- with(mytrain, list(
  duration = mean(duration, na.rm = TRUE),
  days_left = mean(days_left, na.rm = TRUE),

  # Ensure only one category is 1
  classEconomy = 1,
  classBusiness = 0,
  stopstwo_or_more = 0,
  stopszero = 1
))

# Plot scatter plot
plot(price ~ duration, data = mytrain, pch = 19, col = "grey",
     ylim = range(mytrain$price, na.rm = TRUE))

# Add regression curve
drawit(mean_vals)

```

"We can see that this data is very spread out, but this line shows the model's prediction of the price of tickets based on the duration of the flight. This graph shows what the sales price is for Economy class with non-stop flights. We can see the price is always rising and the flights do not get cheaper the further you fly on a non-stop economy flight.

##### Business class non-Stop

```{r message=FALSE, warning=FALSE}
drawit <- function(mean_vals) {
  curve(
    b["(Intercept)"] + 
    b["duration"] * x + 
    b["I(duration^2)"] * x^2 + 
    b["classEconomy"] * mean_vals$classEconomy + 
    b["stopstwo_or_more"] * mean_vals$stopstwo_or_more + 
    b["stopszero"] * mean_vals$stopszero + 
    b["I(days_left^2)"] * mean_vals$days_left^2 + 
    b["duration:classEconomy"] * x * mean_vals$classEconomy + 
    b["I(duration^2):classEconomy"] * x^2 * mean_vals$classEconomy + 
    b["classBusiness:I(duration^3)"] * mean_vals$classBusiness * x^3 + 
    b["classBusiness:days_left"] * mean_vals$classBusiness * mean_vals$days_left + 
    b["classEconomy:I(duration^3)"] * mean_vals$classEconomy * x^3 + 
    b["classEconomy:days_left"] * mean_vals$classEconomy * mean_vals$days_left + 
    b["duration:stopstwo_or_more"] * x * mean_vals$stopstwo_or_more + 
    b["duration:stopszero"] * x * mean_vals$stopszero + 
    b["stopstwo_or_more:days_left"] * mean_vals$stopstwo_or_more * mean_vals$days_left + 
    b["stopszero:days_left"] * mean_vals$stopszero * mean_vals$days_left, 

    from = min(mytrain$duration, na.rm = TRUE), 
    to = max(mytrain$duration, na.rm = TRUE), 
    add = TRUE, col = "blue", lwd = 2, ylab = "Prediction", xlab = "Duration"
  )
}

# Define the mean values correctly
mean_vals <- with(mytrain, list(
  duration = mean(duration, na.rm = TRUE),
  days_left = mean(days_left, na.rm = TRUE),

  # Ensure only one category is 1
  classEconomy = 0,
  classBusiness = 1,
  stopstwo_or_more = 0,
  stopszero = 1
))

# Plot scatter plot
plot(price ~ duration, data = mytrain, pch = 19, col = "grey",
     ylim = range(mytrain$price, na.rm = TRUE))

# Add regression curve
drawit(mean_vals)
```

This graph shows the prediction of flights that are business with a non-stop flight. And again, the price is always increasing for a non-stop flight in Business class, making this not ideal for cheap travel.

##### Economy class Two or More Stops

```{r message=FALSE, warning=FALSE}
drawit <- function(mean_vals) {
  curve(
    b["(Intercept)"] + 
    b["duration"] * x + 
    b["I(duration^2)"] * x^2 + 
    b["classEconomy"] * mean_vals$classEconomy + 
    b["stopstwo_or_more"] * mean_vals$stopstwo_or_more + 
    b["stopszero"] * mean_vals$stopszero + 
    b["I(days_left^2)"] * mean_vals$days_left^2 + 
    b["duration:classEconomy"] * x * mean_vals$classEconomy + 
    b["I(duration^2):classEconomy"] * x^2 * mean_vals$classEconomy + 
    b["classBusiness:I(duration^3)"] * mean_vals$classBusiness * x^3 + 
    b["classBusiness:days_left"] * mean_vals$classBusiness * mean_vals$days_left + 
    b["classEconomy:I(duration^3)"] * mean_vals$classEconomy * x^3 + 
    b["classEconomy:days_left"] * mean_vals$classEconomy * mean_vals$days_left + 
    b["duration:stopstwo_or_more"] * x * mean_vals$stopstwo_or_more + 
    b["duration:stopszero"] * x * mean_vals$stopszero + 
    b["stopstwo_or_more:days_left"] * mean_vals$stopstwo_or_more * mean_vals$days_left + 
    b["stopszero:days_left"] * mean_vals$stopszero * mean_vals$days_left, 

    from = min(mytrain$duration, na.rm = TRUE), 
    to = max(mytrain$duration, na.rm = TRUE), 
    add = TRUE, col = "blue", lwd = 2, ylab = "Prediction", xlab = "Duration"
  )
}

# Define the mean values correctly
mean_vals <- with(mytrain, list(
  duration = mean(duration, na.rm = TRUE),
  days_left = mean(days_left, na.rm = TRUE),

  # Ensure only one category is 1
  classEconomy = 1,
  classBusiness = 0,
  stopstwo_or_more = 1,
  stopszero = 0
))

# Plot scatter plot
plot(price ~ duration, data = mytrain, pch = 19, col = "grey",
     ylim = range(mytrain$price, na.rm = TRUE))

# Add regression curve
drawit(mean_vals)
```


This shows prices for Economy Class with two or more stops. This graph actually decreases in price after about 20 hours of travel, and the price is already cheaper than the normal classes, making it our best option for flights on a budget.


##### Business class non-Stop

```{r message=FALSE, warning=FALSE}
drawit <- function(mean_vals) {
  curve(
    b["(Intercept)"] + 
    b["duration"] * x + 
    b["I(duration^2)"] * x^2 + 
    b["classEconomy"] * mean_vals$classEconomy + 
    b["stopstwo_or_more"] * mean_vals$stopstwo_or_more + 
    b["stopszero"] * mean_vals$stopszero + 
    b["I(days_left^2)"] * mean_vals$days_left^2 + 
    b["duration:classEconomy"] * x * mean_vals$classEconomy + 
    b["I(duration^2):classEconomy"] * x^2 * mean_vals$classEconomy + 
    b["classBusiness:I(duration^3)"] * mean_vals$classBusiness * x^3 + 
    b["classBusiness:days_left"] * mean_vals$classBusiness * mean_vals$days_left + 
    b["classEconomy:I(duration^3)"] * mean_vals$classEconomy * x^3 + 
    b["classEconomy:days_left"] * mean_vals$classEconomy * mean_vals$days_left + 
    b["duration:stopstwo_or_more"] * x * mean_vals$stopstwo_or_more + 
    b["duration:stopszero"] * x * mean_vals$stopszero + 
    b["stopstwo_or_more:days_left"] * mean_vals$stopstwo_or_more * mean_vals$days_left + 
    b["stopszero:days_left"] * mean_vals$stopszero * mean_vals$days_left, 

    from = min(mytrain$duration, na.rm = TRUE), 
    to = max(mytrain$duration, na.rm = TRUE), 
    add = TRUE, col = "blue", lwd = 2, ylab = "Prediction", xlab = "Duration"
  )
}

# Define the mean values correctly
mean_vals <- with(mytrain, list(
  duration = mean(duration, na.rm = TRUE),
  days_left = mean(days_left, na.rm = TRUE),

  # Ensure only one category is 1
  classEconomy = 0,
  classBusiness = 1,
  stopstwo_or_more = 1,
  stopszero = 0
))

# Plot scatter plot
plot(price ~ duration, data = mytrain, pch = 19, col = "grey",
     ylim = range(mytrain$price, na.rm = TRUE))

# Add regression curve
drawit(mean_vals)
```

This graph shows pricing for Business class for flights that have two or more stops. This graph has a slight dip around 20-30 hours for Business class. So, if you want a slight upgrade, then only fly around 20-30 hours with two or more layovers in Business class. But also, the price is much larger than Economy with layovers, so in the end, I would just fly Economy.